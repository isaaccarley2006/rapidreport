{% extends "base.html" %}
{% set nav_active = "ask" %}

{% block title %}Ask â€” RapidReport{% endblock %}

{% block content %}
<style>
    .ask-page { display: flex; flex-direction: column; height: calc(100vh - 64px); }
    .chat-header { margin-bottom: 20px; }
    .chat-window {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 14px;
        padding-bottom: 16px;
    }
    .chat-empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        gap: 12px;
    }
    .chat-empty-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--accent-soft);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .chat-empty-icon svg { width: 22px; height: 22px; color: var(--accent); }
    .chat-empty p { font-size: 14px; }
    .chat-empty .suggestions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; justify-content: center; }
    .suggestion-chip {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 6px 14px;
        font-size: 12px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.15s;
    }
    .suggestion-chip:hover { border-color: var(--accent); color: var(--accent); }

    .chat-msg {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.6;
        animation: fadeUp 0.25s ease;
    }
    @keyframes fadeUp {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .chat-msg.user {
        align-self: flex-end;
        background: var(--accent);
        color: #fff;
        border-bottom-right-radius: 4px;
    }
    .chat-msg.assistant {
        align-self: flex-start;
        background: var(--surface);
        border: 1px solid var(--border);
        border-bottom-left-radius: 4px;
    }
    .chat-msg.assistant strong { color: #fff; }
    .chat-msg.assistant ul, .chat-msg.assistant ol { padding-left: 16px; margin: 6px 0; }
    .chat-msg.assistant li { margin-bottom: 4px; }
    .chat-msg.thinking {
        align-self: flex-start;
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--text-muted);
        border-bottom-left-radius: 4px;
    }
    .dot-pulse { display: inline-flex; gap: 4px; }
    .dot-pulse span {
        width: 6px; height: 6px;
        border-radius: 50%;
        background: var(--text-muted);
        animation: pulse 1.2s infinite;
    }
    .dot-pulse span:nth-child(2) { animation-delay: 0.15s; }
    .dot-pulse span:nth-child(3) { animation-delay: 0.3s; }
    @keyframes pulse {
        0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
        40% { opacity: 1; transform: scale(1); }
    }

    .ask-input-bar {
        padding: 16px 0 8px;
        position: relative;
    }
    .ask-input {
        width: 100%;
        padding: 14px 52px 14px 20px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--text);
        font-size: 14px;
        font-family: inherit;
        outline: none;
        transition: border-color 0.2s;
    }
    .ask-input::placeholder { color: var(--text-muted); }
    .ask-input:focus { border-color: var(--accent); }
    .ask-btn {
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        margin-top: 4px;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        background: var(--accent);
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.15s;
    }
    .ask-btn:hover { opacity: 0.85; }
    .ask-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .ask-btn svg { width: 16px; height: 16px; }
</style>

<div class="ask-page">
    <div class="chat-header">
        <h1 class="page-title">Ask</h1>
        <p class="page-sub">Ask questions about your weekly reports</p>
    </div>

    <div class="chat-window" id="chat-window">
        <div class="chat-empty" id="chat-empty">
            <div class="chat-empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            <p>Ask anything about your work</p>
            <div class="suggestions">
                <span class="suggestion-chip" data-q="What were the key accomplishments this week?">Key accomplishments?</span>
                <span class="suggestion-chip" data-q="What should I prioritize on Monday?">Monday priorities?</span>
                <span class="suggestion-chip" data-q="Summarize the most important emails">Important emails?</span>
                <span class="suggestion-chip" data-q="What partnerships are in progress?">Active partnerships?</span>
            </div>
        </div>
    </div>

    <div class="ask-input-bar">
        <input type="text" id="ask-input" class="ask-input"
               placeholder="What would you like to know?"
               autocomplete="off">
        <button id="ask-btn" class="ask-btn" title="Ask">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const input = document.getElementById('ask-input');
    const btn = document.getElementById('ask-btn');
    const chatWindow = document.getElementById('chat-window');
    const emptyState = document.getElementById('chat-empty');

    // Generate a unique session ID for this browser tab
    let sessionId = sessionStorage.getItem('chat_session_id');
    if (!sessionId) {
        sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);
        sessionStorage.setItem('chat_session_id', sessionId);
    }

    function mdToHtml(text) {
        text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const lines = text.split('\n');
        let html = '';
        let inList = false;
        for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed) {
                if (inList) { html += '</ul>'; inList = false; }
                continue;
            }
            if (/^#{1,3}\s/.test(trimmed)) {
                if (inList) { html += '</ul>'; inList = false; }
                const content = trimmed.replace(/^#{1,3}\s+/, '');
                html += '<strong style="display:block;margin:8px 0 4px;">' + inline(content) + '</strong>';
            } else if (/^[-*]\s/.test(trimmed) || /^\d+\.\s/.test(trimmed)) {
                if (!inList) { html += '<ul>'; inList = true; }
                const content = trimmed.replace(/^[-*]\s|^\d+\.\s/, '');
                html += '<li>' + inline(content) + '</li>';
            } else {
                if (inList) { html += '</ul>'; inList = false; }
                html += '<p style="margin:4px 0;">' + inline(trimmed) + '</p>';
            }
        }
        if (inList) html += '</ul>';
        return html;
    }

    function inline(t) {
        t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        t = t.replace(/\*(.+?)\*/g, '<em>$1</em>');
        return t;
    }

    function addMessage(content, role, isHtml) {
        if (emptyState) emptyState.remove();
        const div = document.createElement('div');
        div.className = 'chat-msg ' + role;
        if (isHtml) {
            div.innerHTML = content;
        } else if (role === 'assistant') {
            div.innerHTML = mdToHtml(content);
        } else {
            div.textContent = content;
        }
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return div;
    }

    async function ask(question) {
        const q = question || input.value.trim();
        if (!q) return;
        input.value = '';
        btn.disabled = true;

        addMessage(q, 'user');
        const thinking = addMessage(
            '<div class="dot-pulse"><span></span><span></span><span></span></div>',
            'thinking', true
        );

        try {
            const res = await fetch('/api/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: q, session_id: sessionId })
            });
            const data = await res.json();
            thinking.remove();
            addMessage(data.answer || data.error, 'assistant');
        } catch (e) {
            thinking.remove();
            addMessage('Something went wrong. Try again.', 'assistant');
        }
        btn.disabled = false;
        input.focus();
    }

    btn.addEventListener('click', () => ask());
    input.addEventListener('keydown', e => { if (e.key === 'Enter') ask(); });

    document.querySelectorAll('.suggestion-chip').forEach(chip => {
        chip.addEventListener('click', () => ask(chip.dataset.q));
    });

    input.focus();
</script>
{% endblock %}
